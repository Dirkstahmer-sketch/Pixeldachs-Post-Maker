<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pixeldachs Post-Maker v3.6.2</title>
<meta name="theme-color" content="#0a0a0b"/>
<link rel="manifest" href="manifest.webmanifest"/>
<style>
:root{--bg:#0a0a0b;--card:#111216;--muted:#a3a3b0;--text:#f1f5f9;--pink:#ff2f7a;--green:#43b047;--violet:#5b3fb3;--yellow:#ffd400;--outline:#222433;--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
*{box-sizing:border-box}html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.logoWrap{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--pink),var(--yellow));display:grid;place-items:center;border:1px solid var(--outline);overflow:hidden}
.logoWrap img{width:100%;height:100%;object-fit:cover}
h1{font-size:22px;margin:0;letter-spacing:.3px}.sub{color:var(--muted);font-size:12px}
.band{height:4px;background:linear-gradient(90deg,var(--pink),var(--green),var(--violet),var(--yellow));border-radius:999px;margin:10px 0 14px;animation:flow 6s linear infinite}
@keyframes flow{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)}}
.card{background:var(--card);border:1px solid var(--outline);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.grid{display:grid;gap:12px}label{font-size:12px;color:var(--muted)}
input[type="text"],select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--outline);background:#0c0d12;color:#fff;outline:none;font-size:15px}
textarea{min-height:120px;resize:vertical;font-family:var(--mono)}
input[type="text"]:focus,select:focus,textarea:focus{border-color:var(--violet)}
.row{display:grid;grid-template-columns:1fr;gap:12px}@media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
.btns{display:flex;flex-wrap:wrap;gap:10px}button{border:0;padding:12px 14px;border-radius:12px;background:linear-gradient(135deg,var(--green),var(--pink));color:#0a0a0b;font-weight:800;letter-spacing:.2px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.35)}
button.secondary{background:linear-gradient(135deg,var(--violet),var(--yellow));color:#0a0a0b}button.ghost{background:transparent;color:#cbd5e1;border:1px dashed var(--outline)}
.small{font-size:12px;color:var(--muted)}.out{background:#0b0c12;border:1px solid var(--outline);border-radius:12px;padding:12px}
.caption{white-space:pre-wrap;font-family:var(--mono);line-height:1.35;font-size:14px}
.pill{font-size:11px;color:#0a0a0b;background:linear-gradient(90deg,var(--pink),var(--green),var(--violet),var(--yellow));padding:4px 10px;border-radius:999px;width:max-content}
.footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.toast{position:fixed;left:12px;right:12px;bottom:12px;background:#111216;color:#e5e7eb;border:1px solid #2c2f3d;border-radius:12px;padding:10px 12px;font-size:13px;opacity:0;transform:translateY(8px);transition:.25s}.toast.show{opacity:1;transform:translateY(0)}
.vault-item{border:1px dashed var(--outline);border-radius:12px;padding:10px}
.hidden{display:none}
/* Button Men√º */
.menu{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:8px 0 14px}
.menu button{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;border-radius:14px;border:1px solid var(--outline);background:#111216;color:#e5e7eb;box-shadow:none}
.menu button.active{background:linear-gradient(135deg,var(--violet),var(--yellow));color:#0a0a0b;font-weight:900}
.menu button .ico{font-size:18px}
@media(min-width:900px){.menu{grid-template-columns:repeat(5,1fr)}}
/* Layout */
.hero{display:grid;gap:12px}@media(min-width:900px){.hero{grid-template-columns:1fr 1fr}}
.heroCard{display:flex;flex-direction:column;gap:8px;justify-content:space-between;background:linear-gradient(135deg,#111216,#0c0d12);border:1px solid var(--outline);border-radius:18px;padding:18px}
.heroCard h2{margin:0}.kicker{color:#a1a1b0;font-size:13px}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
.thumb{position:relative;border:1px solid var(--outline);border-radius:12px;overflow:hidden;background:#0c0d12}
.thumb img{width:100%;height:120px;object-fit:cover;display:block}
.thumb .meta{padding:8px;font-size:12px;color:#cbd5e1}
.thumb .actions{display:flex;gap:6px;padding:8px;flex-wrap:wrap}
canvas{background:#0b0c12;border:1px solid var(--outline);border-radius:12px;max-width:100%}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logoWrap"><img src="logo.png" alt="Pixeldachs"/></div>
    <div><h1>Pixeldachs Post-Maker</h1><div class="sub">v3.6.2 ‚Äì Button-Men√º Bugfix</div></div>
  </header>
  <div class="band"></div>

  <!-- BUTTON MENU -->
  <div class="menu" role="tablist" aria-label="Hauptmen√º">
    <button class="active" data-go="home" aria-selected="true"><span class="ico">üè†</span> Start</button>
    <button data-go="texts"><span class="ico">‚úçÔ∏è</span> Texte</button>
    <button data-go="analytics"><span class="ico">üìä</span> Analyse</button>
    <button data-go="images"><span class="ico">üñºÔ∏è</span> Bilder</button>
    <button data-go="tiles"><span class="ico">üî≤</span> Kacheln</button>
    <button data-go="settings"><span class="ico">‚öôÔ∏è</span> Einstellungen</button>
  </div>

  <!-- HOME -->
  <section id="home" class="grid" style="margin-top:6px;">
    <div class="hero">
      <div class="heroCard">
        <div>
          <div class="kicker">Schnell starten</div>
          <h2>Texte ‚Äì Pixeldachs entdeckt</h2>
          <p>ASIN/URL einf√ºgen (oder via Teilen senden) ‚Üí Tracking w√§hlen ‚Üí bis zu 3 Pixeldachs-Varianten generieren ‚Üí WhatsApp teilen.</p>
        </div>
        <div class="right"><button class="secondary" data-go="texts">Los geht's</button></div>
      </div>
      <div class="heroCard">
        <div>
          <div class="kicker">Neues</div>
          <h2>Kachel-Designer</h2>
          <p>Erzeuge 1080√ó1080 oder 16:9 Promo-Kacheln mit 3 Stilen, Logo-Toggle & Hashtags.</p>
        </div>
        <div class="right"><button class="ghost" data-go="tiles">Zu Kacheln</button></div>
      </div>
    </div>
  </section>

  <!-- TEXTS -->
  <section id="texts" class="hidden" style="margin-top:6px;">
    <div class="card grid">
      <div class="row">
        <div><label for="url">Amazon URL oder ASIN</label><input type="text" id="url" placeholder="https://www.amazon.de/dp/B0C123ABCD/ oder B0C123ABCD"></div>
        <div><label for="tag">Tracking-ID</label>
          <select id="tag">
            <option value="whatsdachs-21">whatsdachs-21 (Standard)</option>
            <option value="dachsdeal-21">dachsdeal-21 (Deals)</option>
            <option value="dachstipps-21">dachstipps-21 (Tipps)</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label for="nutzen">Nutzungs-Szenario (optional, 3‚Äì6 W√∂rter)</label><input type="text" id="nutzen" placeholder="z.B. Bernstein am Strand"></div>
        <div><label for="product">Produktname (optional)</label><input type="text" id="product" placeholder="z.B. UV-Taschenlampe 395 nm"></div>
      </div>
      <div class="row">
        <div><label for="style">Stil</label>
          <select id="style">
            <option value="Entdecker">üü¢ Entdecker & Tipp</option>
            <option value="Deals">üü£ Deals & Schn√§ppchen</option>
            <option value="Alltag">üü° Alltag & Tricks</option>
          </select>
        </div>
        <div><label for="domain">Amazon-Domain</label>
          <select id="domain">
            <option value="https://www.amazon.de">amazon.de</option>
            <option value="https://www.amazon.com">amazon.com</option>
            <option value="https://www.amazon.co.uk">amazon.co.uk</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label for="hashtags">Hashtag-Presets (kommasepariert)</label><input type="text" id="hashtags" placeholder="#pixeldachs,#entdeckt,#gadget,#amazonfinds"></div>
        <div><label for="count">Anzahl Varianten (max. 3)</label><select id="count"><option>1</option><option selected>2</option><option>3</option></select></div>
      </div>
    </div>

    <div class="card grid" style="margin-top:6px;">
      <div class="grid"><div class="pill">Affiliate-Link</div><div id="asinOut" class="small"></div><div id="linkOut" class="out"></div></div>
      <div id="caps"></div>
      <div class="footer">
        <span class="small">Vault (lokal): Letzte Posts</span>
        <button class="ghost" id="exportVault">Vault als CSV kopieren</button>
      </div>
      <div id="vault" class="grid"></div>
    </div>
  </section>

  <!-- ANALYTICS -->
  <section id="analytics" class="hidden" style="margin-top:6px;">
    <div class="card grid">
      <div class="row">
        <div class="out"><div class="pill">Zusammenfassung</div><div id="sumStats" class="small"></div></div>
        <div class="out"><div class="pill">Top-Hashtags</div><div id="topTags" class="small"></div></div>
      </div>
      <div class="row">
        <div><div class="pill">Stil-Mix</div><canvas id="stylePie" width="480" height="320"></canvas></div>
        <div><div class="pill">Top-Hashtags</div><canvas id="tagsBar" width="480" height="320"></canvas></div>
      </div>
      <div class="grid">
        <div class="pill">Letzte 10 Posts</div>
        <div id="lastPosts" class="grid"></div>
      </div>
    </div>
  </section>

  <!-- IMAGES -->
  <section id="images" class="hidden" style="margin-top:6px;">
    <div class="card grid">
      <div class="row">
        <div>
          <label for="imgUpload">Bilder hochladen (PNG/JPG/WEBP)</label>
          <input type="file" id="imgUpload" accept=".png,.jpg,.jpeg,.webp" multiple>
        </div>
        <div class="btns" style="align-items:end">
          <button id="importJson" class="ghost">Import (JSON)</button>
          <button id="exportJson" class="ghost">Export (JSON)</button>
        </div>
      </div>
      <div class="grid">
        <div class="pill">Galerie</div>
        <div id="gallery" class="gallery"></div>
      </div>
    </div>

    <div class="card grid">
      <div class="pill">Pro-Overlay</div>
      <div class="row">
        <div><label for="overlayText">Overlay-Text</label><input type="text" id="overlayText" placeholder="Kurz & knackig, z. B. 'Bernstein-Check'"></div>
        <div><label for="overlayPos">Position</label>
          <select id="overlayPos">
            <option value="top-left">Oben links</option>
            <option value="top-right">Oben rechts</option>
            <option value="bottom-left" selected>Unten links</option>
            <option value="bottom-right">Unten rechts</option>
            <option value="center">Zentriert</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label for="overlaySize">Textgr√∂√üe</label><select id="overlaySize"><option>Small</option><option selected>Medium</option><option>Large</option></select></div>
        <div><label for="overlayOpacity">Leisten-Transparenz</label><input id="overlayOpacity" type="range" min="0" max="100" value="35"></div>
      </div>
      <div class="row">
        <div><label for="overlayOutline">Text-Outline</label><select id="overlayOutline"><option value="none">Keine</option><option value="light">Hell</option><option value="dark" selected>Dunkel</option></select></div>
        <div><label for="overlayLogo">Logo</label><select id="overlayLogo"><option value="on" selected>An</option><option value="off">Aus</option></select></div>
      </div>
      <div class="row">
        <div><label for="overlaySticker">Sticker</label>
          <select id="overlaySticker">
            <option value="">Kein Sticker</option>
            <option>Getestet vom Pixeldachs</option>
            <option>Pixeldachs Tipp des Tages</option>
            <option>Wochenend-Tipp</option>
          </select>
        </div>
        <div class="btns" style="align-items:end">
          <button id="applyOverlay" class="secondary">Overlay anwenden (auf gew√§hltes Bild)</button>
        </div>
      </div>
      <canvas id="overlayCanvas" width="1080" height="1080"></canvas>
      <div class="small">Ablauf: In der Galerie ein Bild antippen (wird markiert) ‚Üí Optionen w√§hlen ‚Üí ‚ÄûOverlay anwenden‚Äú. Ergebnis wird als neues Bild gespeichert.</div>
    </div>
  </section>

  <!-- TILES -->
  <section id="tiles" class="hidden" style="margin-top:6px;">
    <div class="card grid">
      <div class="row">
        <div><label for="tileText">Kachel-Text (kurz)</label><input type="text" id="tileText" placeholder="z. B. UV-Lampe im Check"></div>
        <div><label for="tileHashtags">Hashtags (optional)</label><input type="text" id="tileHashtags" placeholder="#pixeldachs #entdeckt"></div>
      </div>
      <div class="row">
        <div><label for="tileStyle">Stil</label>
          <select id="tileStyle">
            <option value="retro">ü©µ Pixeldachs Retro</option>
            <option value="modern" selected>üíõ Modern Gradient</option>
            <option value="comic">üß° Comic Boom</option>
          </select>
        </div>
        <div><label for="tileAspect">Format</label>
          <select id="tileAspect">
            <option value="square" selected>Quadrat 1080√ó1080</option>
            <option value="widescreen">16:9 (1920√ó1080)</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label for="tileLogo">Logo</label><select id="tileLogo"><option value="on" selected>An</option><option value="off">Aus</option></select></div>
        <div class="btns" style="align-items:end"><button id="makeTile" class="secondary">Kachel erzeugen</button></div>
      </div>
      <canvas id="tileCanvas" width="1080" height="1080"></canvas>
      <div class="small">Tipp: vorher in ‚ÄûBilder‚Äú ein Produktfoto ausw√§hlen ‚Äì wird automatisch als Hintergrund genutzt.</div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="hidden" style="margin-top:6px;">
    <div class="card grid">
      <div class="pill">App-Wartung</div>
      <div class="btns">
        <button id="resetCache" class="ghost">Cache & Service Worker l√∂schen</button>
        <button id="clearVault" class="ghost">Vault leeren</button>
        <button id="clearImages" class="ghost">Alle Bilder l√∂schen</button>
      </div>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
// --- Helpers ---
function $(sel){return document.querySelector(sel)}
const toast=$('#toast'); function showToast(m){ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1400); }
const LSKEY='pixeldachs_prefs_v3_6_2'; const VAULT_KEY='pixeldachs_vault_v3_6_2'; const STRAT_KEY='pixeldachs_strategy_v3_6_2';

// --- Navigation (Buttons) ---
const sections={home:$('#home'),texts:$('#texts'),analytics:$('#analytics'),images:$('#images'),tiles:$('#tiles'),settings:$('#settings')};
function show(name){ Object.values(sections).forEach(s=>s.classList.add('hidden')); Object.keys(sections).forEach(k=>{ const b=document.querySelector('.menu button[data-go="'+k+'"]'); if(b) b.classList.remove('active'); }); sections[name].classList.remove('hidden'); const act=document.querySelector('.menu button[data-go="'+name+'"]'); if(act) act.classList.add('active'); window.location.hash=name; }
document.addEventListener('click', (e)=>{ const btn=e.target.closest('[data-go]'); if(!btn) return; e.preventDefault(); const go=btn.getAttribute('data-go'); if(go && sections[go]) show(go); });
if(location.hash && sections[location.hash.slice(1)]) show(location.hash.slice(1)); else show('home');

// --- PWA + Share Target ---
if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }
(function(){ try{ const u=new URL(location.href); const shared=u.searchParams.get('url')||u.searchParams.get('text'); if(shared){ show('texts'); $('#url').value=shared; showToast('Geteilte URL √ºbernommen'); history.replaceState({},'',location.pathname); } }catch{} })();

// --- Hooks & CTAs ---
const HOOKS={Entdecker:["Heute hat der Pixeldachs etwas Spannendes entdeckt ü¶°","Kleiner Fund am Strand ‚Äì gro√üer Aha-Moment üòé","Schon mal probiert? Der Pixeldachs war neugierig ‚Ä¶","Mini-Experiment vom Pixeldachs ‚Äì mit verbl√ºffendem Ergebnis","Geheimtipp f√ºr Abenteurer und Finder üß≠"],Deals:["Schn√§ppchen-Alarm üí∏ ‚Äì der Pixeldachs war wieder unterwegs!","Kurzzeitig g√ºnstiger! üî•","Preis-Leistungs-Hit, den man leicht √ºbersieht üëÄ","Heute spart der Pixeldachs richtig ‚Äì und du vielleicht auch","Deal entdeckt ‚Äì bevor er wieder weg ist ‚è≥"],Alltag:["Mini-Trick vom Pixeldachs üòâ","So simpel, aber so praktisch üß†","Haushalts-Helfer, der wirklich was bringt","Kleines Tool, gro√üe Wirkung","F√ºr Haustier- und Alltagssituationen top üêæ"]};
const CTAS={Entdecker:["Viel Erfolg beim Suchen ü¶°","Zeig mal, was du findest üëá","Hier entlang ‚Üí {link}"],Deals:["Hier entdecken ‚Üí {link}","Nur solange der Deal l√§uft üî•","Bevor es weg ist ‚Üí {link}"],Alltag:["Ausprobieren lohnt sich üòâ","Schon getestet? ü¶°","Direkt checken ‚Üí {link}"]};
function rand(a){return a[Math.floor(Math.random()*a.length)]}
function tagsString(){const raw=$('#hashtags')?.value?.trim?.()||"";return raw?raw.split(',').map(s=>s.trim()).filter(Boolean).join(' '):''}

// --- Prefs ---
function loadPrefs(){ try{const raw=localStorage.getItem(LSKEY); if(!raw) return; const p=JSON.parse(raw); ['tag','style','hashtags','count','domain'].forEach(k=>{ if(p[k]!==undefined && $('#'+k)) $('#'+k).value=p[k]; }); }catch{} }
function savePrefs(){ const p={tag:$('#tag').value, style:$('#style').value, hashtags:$('#hashtags').value, count:$('#count').value, domain:$('#domain').value}; localStorage.setItem(LSKEY, JSON.stringify(p)); showToast('Einstellungen gespeichert'); }
document.getElementById('savePrefsBtn')?.addEventListener('click', savePrefs); loadPrefs();

// --- ASIN & Link ---
function extractASIN(input){ input=(input||'').trim(); let cleaned=input.replace(/[\s\u200B]+/g,'').toUpperCase(); const m1=cleaned.match(/(?:\/DP\/|\/GP\/PRODUCT\/|\/PRODUCT\/)([A-Z0-9]{10})/i); if(m1) return m1[1].toUpperCase(); const m2=cleaned.match(/([A-Z0-9]{10})/); if(m2) return m2[1].toUpperCase(); return null; }
function buildLink(asin, tag, domain){ const base=(domain||'https://www.amazon.de').replace(/\/$/,''); return base + '/dp/' + asin + '?tag=' + encodeURIComponent(tag); }

// --- Caption Engine ---
function makeCaption(style, name, nutzen, link){
  const hook = rand(HOOKS[style]||[]);
  const cta = (rand(CTAS[style]||[])||'Hier entlang ‚Üí {link}').replace('{link}', link);
  const parts = [hook]; if (nutzen) parts.push(nutzen); parts.push('Partnerlink: ' + link, cta);
  const text = parts.filter(Boolean).join('\n\n'); const tags = tagsString();
  return tags ? text + '\n' + tags : text;
}
function renderCaptions(arr){
  const capsWrap=$('#caps'); capsWrap.innerHTML='';
  arr.forEach((t,i)=>{ const box=document.createElement('div'); box.className='grid'; box.innerHTML=`<div class="pill">Caption ${i+1}</div><div class="out caption"></div><div class="btns"><button class="ghost">Kopieren</button></div>`; box.querySelector('.caption').textContent=t; box.querySelector('button').addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(t); box.querySelector('button').textContent='Kopiert ‚úì'; setTimeout(()=>box.querySelector('button').textContent='Kopieren',1100); }catch(e){ showToast('Kopieren nicht m√∂glich'); } }); capsWrap.appendChild(box); });
}

// --- Vault ---
function addToVault(entry){ try{ const raw=localStorage.getItem(VAULT_KEY); const list=raw?JSON.parse(raw):[]; list.unshift(entry); if(list.length>250) list.length=250; localStorage.setItem(VAULT_KEY, JSON.stringify(list)); renderVault(); }catch{} }
function renderVault(){ const vaultWrap=$('#vault'); if(!vaultWrap) return; vaultWrap.innerHTML=''; try{ const raw=localStorage.getItem(VAULT_KEY); if(!raw) return; const list=JSON.parse(raw).slice(0,20); list.forEach(item=>{ const div=document.createElement('div'); div.className='vault-item'; const preview=item.text.length>220? item.text.slice(0,220)+'‚Ä¶' : item.text; div.innerHTML=`<div class="small">${item.date} ¬∑ ${item.asin} ¬∑ ${item.style}</div><div style="margin:6px 0" class="out caption">${preview}</div><div class="btns"><button class="ghost">Kopieren</button></div>`; div.querySelector('button').addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(item.text); showToast('Vault-Text kopiert'); }catch{ showToast('Kopieren nicht m√∂glich'); } }); vaultWrap.appendChild(div); }); }catch{} }
renderVault();
function exportVault(){ try{ const raw=localStorage.getItem(VAULT_KEY); if(!raw){ showToast('Vault leer'); return; } const list=JSON.parse(raw); const header='date,asin,style,link\n'; const rows=list.map(v=>`"${v.date}","${v.asin}","${v.style}","${v.link}"`).join('\n'); const csv=header+rows; navigator.clipboard.writeText(csv).then(()=>showToast('CSV in Zwischenablage')).catch(()=>showToast('CSV Kopie fehlgeschlagen')); }catch{ showToast('Export fehlgeschlagen'); } }
document.getElementById('exportVault').addEventListener('click', exportVault);

// --- Generate ---
document.getElementById('gen')?.addEventListener('click',()=>{ const raw=$('#url').value.trim(); const tag=$('#tag').value.trim(); const nutzen=$('#nutzen').value.trim(); const name=$('#product').value.trim()||'Gadget'; const style=$('#style').value; if(!raw){ showToast('Bitte Amazon-URL oder ASIN eingeben.'); return; } if(!tag){ showToast('Tracking-ID fehlt.'); return; } const asin=extractASIN(raw); if(!asin){ showToast('Keine ASIN gefunden.'); return; } const link=buildLink(asin, tag, $('#domain').value); $('#asinOut').textContent='ASIN erkannt: '+asin; $('#linkOut').textContent=link; const n=Math.min(3, parseInt($('#count').value,10)||1); const out=[]; for(let i=0;i<n;i++) out.push(makeCaption(style, name, nutzen, link)); renderCaptions(out); const timestamp=new Date().toISOString().replace(/[-:T]/g,'').slice(0,12); addToVault({date:timestamp, asin, style, link, text:out[0]}); });
document.getElementById('clear')?.addEventListener('click',()=>{ ['url','nutzen','product'].forEach(id=>{$('#'+id).value=''}); $('#asinOut').textContent=''; $('#linkOut').textContent=''; $('#caps').innerHTML=''; });
document.getElementById('share')?.addEventListener('click',async()=>{ const first=document.querySelector('#caps .caption'); const text=first?first.textContent:$('#linkOut').textContent; if(!text){ showToast('Bitte erst generieren.'); return; } if(navigator.share){ try{ await navigator.share({text}); }catch{} } else{ window.open('https://wa.me/?text='+encodeURIComponent(text),'_blank'); } });

// --- Analytics ---
function analyze(){ const sum=$('#sumStats'), top=$('#topTags'), last=$('#lastPosts'); sum.textContent = top.textContent = ''; last.innerHTML=''; try{ const raw=localStorage.getItem(VAULT_KEY); if(!raw){ sum.textContent='Noch keine Daten.'; drawStylePie({}); drawTagsBar([]); return; } const list=JSON.parse(raw); const total=list.length; const styles={Entdecker:0,Deals:0,Alltag:0}; const hashtags={}; list.forEach(v=>{ styles[v.style]=(styles[v.style]||0)+1; const m=v.text.match(/#[\w√§√∂√º√Ñ√ñ√ú√ü]+/g); if(m){ m.forEach(t=>{ hashtags[t]=(hashtags[t]||0)+1; }); } }); sum.textContent = `Gesamt: ${total} ¬∑ Stile ‚Äì Entdecker ${styles.Entdecker||0}, Deals ${styles.Deals||0}, Alltag ${styles.Alltag||0}`; const top5arr = Object.entries(hashtags).sort((a,b)=>b[1]-a[1]).slice(0,10); top.textContent = top5arr.length? top5arr.map(([k,v])=>k+' ('+v+')').join('  ') : 'Keine Hashtags gefunden.'; drawStylePie(styles); drawTagsBar(top5arr); list.slice(0,10).forEach(v=>{ const div=document.createElement('div'); div.className='vault-item'; const preview=v.text.length>220? v.text.slice(0,220)+'‚Ä¶' : v.text; div.innerHTML=`<div class="small">${v.date} ¬∑ ${v.asin} ¬∑ ${v.style}</div><div class="out caption">${preview}</div>`; last.appendChild(div); }); }catch{ sum.textContent='Fehler bei der Analyse.'; } }
document.querySelector('[data-go="analytics"]').addEventListener('click', analyze);

// --- Charts ---
function drawStylePie(styles){ const c=document.getElementById('stylePie'); if(!c) return; const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const vals=[styles.Entdecker||0, styles.Deals||0, styles.Alltag||0]; const labels=['Entdecker','Deals','Alltag']; const total=vals.reduce((a,b)=>a+b,0)||1; let start=0; const colors=['#5b3fb3','#ff2f7a','#43b047']; vals.forEach((v,i)=>{ const angle=(v/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(c.width/2,c.height/2); ctx.arc(c.width/2,c.height/2,120,start,start+angle); ctx.closePath(); ctx.fillStyle=colors[i%colors.length]; ctx.fill(); start+=angle; ctx.fillStyle='#e5e7eb'; ctx.fillRect(20,20+i*22,12,12); ctx.fillStyle='#cbd5e1'; ctx.font='12px sans-serif'; ctx.fillText(labels[i]+': '+v, 38,30+i*22); }); }
function drawTagsBar(entries){ const c=document.getElementById('tagsBar'); if(!c) return; const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const pad=30; const maxW=c.width-pad*2; const maxH=c.height-pad*2; const vals=entries.map(e=>e[1]); const labels=entries.map(e=>e[0]); const max=Math.max(1, ...vals); const barW=maxW/(Math.max(1, vals.length)); const baseY=c.height-pad; ctx.strokeStyle='#2c2f3d'; ctx.strokeRect(pad,pad,maxW,maxH); vals.forEach((v,i)=>{ const h = (v/max)*maxH; ctx.fillStyle='#ffd400'; ctx.fillRect(pad+i*barW+6, baseY-h, barW-12, h); ctx.fillStyle='#cbd5e1'; ctx.font='11px sans-serif'; ctx.fillText(String(v), pad+i*barW+10, baseY-h-6); ctx.save(); ctx.translate(pad+i*barW+10, baseY+12); ctx.rotate(-Math.PI/4); ctx.fillText(labels[i], 0,0); ctx.restore(); }); }

// --- Images (IndexedDB) ---
let db; const DB_NAME='pixeldachs_images_db_v3_6_2'; const STORE='images';
function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=(e)=>{ const db=e.target.result; if(!db.objectStoreNames.contains(STORE)){ db.createObjectStore(STORE,{keyPath:'id',autoIncrement:true}); } }; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
async function withDB(fn){ db=db||await openDB(); return fn(db); }
function addImage(rec){ return withDB(d=> new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readwrite'); tx.objectStore(STORE).add(rec).onsuccess=(e)=>res(e.target.result); tx.onerror=()=>rej(tx.error);})); }
function getAllImages(){ return withDB(d=> new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).getAll(); req.onsuccess=()=>res(req.result||[]); req.onerror=()=>rej(req.error);})); }
function deleteImage(id){ return withDB(d=> new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readwrite'); tx.objectStore(STORE).delete(id).onsuccess=()=>res(true); tx.onerror=()=>rej(tx.error);})); }
function clearImages(){ return withDB(d=> new Promise((res,rej)=>{ const tx=d.transaction(STORE,'readwrite'); tx.objectStore(STORE).clear().onsuccess=()=>res(true); tx.onerror=()=>rej(tx.error);})); }

let selectedImageId=null;
async function refreshGallery(){ const gal=$('#gallery'); gal.innerHTML=''; const items=await getAllImages(); if(!items.length){ gal.innerHTML='<div class="small">Noch keine Bilder gespeichert.</div>'; return; } items.sort((a,b)=>b.added-a.added); items.forEach(it=>{ const div=document.createElement('div'); div.className='thumb'; div.innerHTML=`<img src="${it.data}" alt="${it.name}"/><div class="meta">${it.name} ¬∑ ${(it.size/1024).toFixed(1)} KB</div><div class="actions"><button class="ghost" data-act="select">${selectedImageId===it.id?'Ausgew√§hlt ‚úì':'Ausw√§hlen'}</button><button class="ghost" data-act="copy">Link kopieren</button><button class="ghost" data-act="dl">Download</button><button class="ghost" data-act="del">L√∂schen</button></div>`; div.querySelector('[data-act="select"]').addEventListener('click',()=>{ selectedImageId=it.id; refreshGallery(); loadOnCanvas(it.data); }); div.querySelector('[data-act="copy"]').addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(it.data); showToast('Bild-Data-URL kopiert'); }catch{ showToast('Kopieren fehlgeschlagen'); } }); div.querySelector('[data-act="dl"]').addEventListener('click',()=>{ const a=document.createElement('a'); a.href=it.data; a.download=it.name||'pixeldachs.png'; document.body.appendChild(a); a.click(); a.remove(); }); div.querySelector('[data-act="del"]').addEventListener('click',async()=>{ await deleteImage(it.id); if(selectedImageId===it.id) selectedImageId=null; showToast('Bild gel√∂scht'); refreshGallery(); }); gal.appendChild(div); }); }
document.getElementById('imgUpload').addEventListener('change', async (e)=>{ const files=[...e.target.files]; for(const f of files){ const reader=new FileReader(); await new Promise((res,rej)=>{ reader.onload=async ()=>{ await addImage({name:f.name,type:f.type,size:f.size,added:Date.now(),data:reader.result}); res(); }; reader.onerror=rej; reader.readAsDataURL(f); }); } showToast(files.length + ' Bild(er) gespeichert'); refreshGallery(); e.target.value=''; });
document.getElementById('exportJson').addEventListener('click', async()=>{ const items=await getAllImages(); const blob=new Blob([JSON.stringify(items)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pixeldachs_images.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });
document.getElementById('importJson').addEventListener('click', ()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange=async (e)=>{ const f=e.target.files[0]; if(!f) return; const txt=await f.text(); let arr=[]; try{arr=JSON.parse(txt)}catch{showToast('JSON fehlerhaft'); return;} for(const it of arr){ await addImage({name:it.name||'import.png',type:it.type||'image/png',size:it.size||0,added:Date.now(),data:it.data||''}); } showToast('Import abgeschlossen'); refreshGallery(); }; inp.click(); });
document.getElementById('clearImages').addEventListener('click', async()=>{ await clearImages(); selectedImageId=null; refreshGallery(); showToast('Alle Bilder gel√∂scht'); });

// --- Overlay ---
const canvas=document.getElementById('overlayCanvas'); const ctx=canvas.getContext('2d');
let canvasImage=null; const logoImg=new Image(); logoImg.src='logo.png';
function loadOnCanvas(data){ const img=new Image(); img.onload=()=>{ canvas.width=1080; canvas.height=1080; const r=Math.max(canvas.width/img.width, canvas.height/img.height); const w=img.width*r, h=img.height*r; const x=(canvas.width-w)/2, y=(canvas.height-h)/2; ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,x,y,w,h); canvasImage=img; }; img.src=data; }
function drawOutlineText(context, text, x, y, outline){ context.save(); context.textBaseline='middle'; if(outline==='light'){ context.strokeStyle='rgba(255,255,255,.9)'; context.lineWidth=4; context.strokeText(text,x,y); } else if(outline==='dark'){ context.strokeStyle='rgba(0,0,0,.9)'; context.lineWidth=4; context.strokeText(text,x,y); } context.fillStyle='#fff'; context.fillText(text,x,y); context.restore(); }
function applyOverlay(){ if(!canvasImage){ showToast('Bitte in der Galerie ein Bild ausw√§hlen.'); return; } const text=$('#overlayText').value.trim(); const pos=$('#overlayPos').value; const sizeSel=$('#overlaySize').value; const opacity=parseInt($('#overlayOpacity').value,10)/100; const outline=$('#overlayOutline').value; const logoOn=$('#overlayLogo').value==='on'; const sticker=$('#overlaySticker').value;
  const fontSize = sizeSel==='Large'? 72 : sizeSel==='Small'? 36 : 56;
  ctx.save(); ctx.globalAlpha=Math.max(0,Math.min(1,opacity)); let bx=0,by=0,bw=canvas.width,bh=fontSize*1.8; if(pos.includes('bottom')) by=canvas.height-bh; if(pos.includes('right')) bx=canvas.width-bw; if(pos==='center'){ by=(canvas.height-bh)/2; } ctx.fillStyle='#000'; ctx.fillRect(bx,by,bw,bh); ctx.restore();
  ctx.font='bold '+fontSize+'px sans-serif'; let tx=40, ty= (pos.includes('bottom')? canvas.height - (fontSize*0.9) : fontSize*0.9); if(pos.includes('right')) tx=canvas.width-40; if(pos==='center'){ ty=canvas.height/2; } if(pos.includes('right')){ ctx.textAlign='right'; } else { ctx.textAlign='left'; }
  if(text) drawOutlineText(ctx, text, tx, ty, outline);
  if(logoOn){ const ls=fontSize*1.2; const lx = pos.includes('right')? (tx - ls - 16) : (tx + 16); const ly = ty - ls/2; try{ ctx.save(); ctx.beginPath(); ctx.roundRect(lx, ly, ls, ls, 12); ctx.clip(); ctx.drawImage(logoImg, lx, ly, ls, ls); ctx.restore(); }catch(e){ ctx.drawImage(logoImg, lx, ly, ls, ls); } }
  if(sticker){ ctx.save(); ctx.translate(canvas.width-40, 40); ctx.fillStyle='rgba(255,212,0,.9)'; ctx.strokeStyle='rgba(0,0,0,.6)'; ctx.lineWidth=3; ctx.beginPath(); try{ ctx.roundRect(-180,-30,180,60,14);}catch(e){ ctx.rect(-180,-30,180,60);} ctx.fill(); ctx.stroke(); ctx.fillStyle='#0a0a0b'; ctx.font='bold 24px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(sticker, -90, 0); ctx.restore(); }
  const dataURL=canvas.toDataURL('image/png'); const ts=new Date().toISOString().replace(/[-:T]/g,'').slice(0,8); const base=(text||'overlay').toLowerCase().replace(/[^a-z0-9√§√∂√º√Ñ√ñ√ú√ü]+/g,'-').replace(/^-+|-+$/g,''); addImage({name:(base || 'overlay')+'_'+ts+'.png', type:'image/png', size=dataURL.length, added:Date.now(), data:dataURL}).then(()=>{ showToast('Overlay gespeichert (Galerie)'); refreshGallery(); });
}
document.getElementById('applyOverlay').addEventListener('click', applyOverlay);

// --- Tiles ---
const tileCanvas=document.getElementById('tileCanvas'); const tctx=tileCanvas.getContext('2d');
async function getSelectedImage(){ const all=await getAllImages(); return all.find(i=>i.id===selectedImageId); }
function setTileSize(aspect){ if(aspect==='widescreen'){ tileCanvas.width=1920; tileCanvas.height=1080; } else { tileCanvas.width=1080; tileCanvas.height=1080; } }
function drawTileBG(style, aspect, imgData){
  const w=tileCanvas.width, h=tileCanvas.height;
  const grad=tctx.createLinearGradient(0,0,w,h);
  if(style==='retro'){ grad.addColorStop(0,'#ff2f7a'); grad.addColorStop(.5,'#43b047'); grad.addColorStop(1,'#5b3fb3'); }
  else if(style==='comic'){ grad.addColorStop(0,'#ff9a00'); grad.addColorStop(1,'#ff2f7a'); }
  else { grad.addColorStop(0,'#0f172a'); grad.addColorStop(1,'#1e293b'); }
  tctx.fillStyle=grad; tctx.fillRect(0,0,w,h);
  if(imgData){ const img=new Image(); img.onload=()=>{ const r=Math.max(w/img.width,h/img.height); const iw=img.width*r, ih=img.height*r; const ix=(w-iw)/2, iy=(h-ih)/2; tctx.globalAlpha=.35; tctx.drawImage(img, ix, iy, iw, ih); tctx.globalAlpha=1; }; img.src=imgData; }
}
function drawTile(style, text, hashtags, logoOn){
  const w=tileCanvas.width, h=tileCanvas.height;
  tctx.save();
  if(style==='retro'){ tctx.fillStyle='rgba(255,212,0,.92)'; tctx.fillRect(40, h*0.65, w-80, 140); tctx.fillStyle='#0a0a0b'; tctx.font='bold 64px sans-serif'; tctx.fillText(text, 60, h*0.65+90); }
  else if(style==='comic'){ tctx.save(); tctx.fillStyle='rgba(0,0,0,.35)'; tctx.fillRect(0, h*0.6, w, h*0.4); tctx.restore(); tctx.font='bold 80px sans-serif'; tctx.strokeStyle='#000'; tctx.lineWidth=6; tctx.strokeText(text, 60, h*0.7); tctx.fillStyle='#fff'; tctx.fillText(text, 60, h*0.7); }
  else { const grd=tctx.createLinearGradient(40,h*0.6,w-40,h-40); grd.addColorStop(0,'rgba(91,63,179,.9)'); grd.addColorStop(1,'rgba(255,47,122,.9)'); try{ tctx.roundRect(40, h*0.6, w-80, 160, 22); }catch(e){ tctx.rect(40, h*0.6, w-80, 160); } tctx.fillStyle=grd; tctx.fill(); tctx.fillStyle='#fff'; tctx.font='bold 64px sans-serif'; tctx.fillText(text, 60, h*0.6+105); }
  if(hashtags){ tctx.fillStyle='rgba(203,213,225,.95)'; tctx.font='28px sans-serif'; tctx.fillText(hashtags, 60, h-40); }
  if(logoOn){ const ls=120; const img=new Image(); img.onload=()=>{ tctx.save(); try{ tctx.beginPath(); tctx.roundRect(w-ls-40,40,ls,ls,18); tctx.clip(); }catch(e){ } tctx.drawImage(img, w-ls-40, 40, ls, ls); tctx.restore(); }; img.src='logo.png'; }
  tctx.restore();
}
document.getElementById('makeTile').addEventListener('click', async()=>{
  const text=($('#tileText').value||'Pixeldachs Tipp').slice(0,40);
  const tags=$('#tileHashtags').value||'';
  const style=$('#tileStyle').value;
  const aspect=$('#tileAspect').value;
  const logoOn=$('#tileLogo').value==='on';
  setTileSize(aspect);
  const sel=await getSelectedImage();
  drawTileBG(style, aspect, sel? sel.data : null);
  drawTile(style, text, tags, logoOn);
  const dataURL=tileCanvas.toDataURL('image/png');
  const ts=new Date().toISOString().replace(/[-:T]/g,'').slice(0,8);
  const base=(text||'kachel').toLowerCase().replace(/[^a-z0-9√§√∂√º√Ñ√ñ√ú√ü]+/g,'-').replace(/^-+|-+$/g,'');
  addImage({name:(base || 'kachel')+'_'+ts+'.png', type:'image/png', size=dataURL.length, added:Date.now(), data:dataURL}).then(()=>{ showToast('Kachel gespeichert (Galerie)'); refreshGallery(); });
});

// --- Settings ---
document.getElementById('resetCache').addEventListener('click', async()=>{
  try{
    if('caches' in window){ const names=await caches.keys(); await Promise.all(names.map(n=>caches.delete(n))); }
    if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister())); }
    showToast('Cache & SW gel√∂scht ‚Äì lade neu ‚Ä¶'); setTimeout(()=>location.reload(true),800);
  }catch(e){ showToast('Reset fehlgeschlagen'); }
});
document.getElementById('clearVault').addEventListener('click', ()=>{ localStorage.removeItem(VAULT_KEY); renderVault(); showToast('Vault geleert'); });
</script>
</body>
</html>